<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="prev" title="Database" href="datastructures/database.html" />
        <link rel="canonical" href="https://exasim-project.com/NeoN/mpi_architecture.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>MPI Architecture - NeoN documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=6a4ff913" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">NeoN  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">NeoN  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Welcome to NeoN!</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="basics/index.html">Basics</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Basics</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="basics/executor.html">Executor</a></li>
<li class="toctree-l2"><a class="reference internal" href="basics/fields.html">Vectors</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="basics/algorithms.html">Parallel Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Parallel Algorithms</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="basics/freeFunctions/fill.html"><code class="docutils literal notranslate"><span class="pre">fill</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="basics/freeFunctions/map.html"><code class="docutils literal notranslate"><span class="pre">map</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="basics/registerclass.html">Derived class discovery at compile time</a></li>
<li class="toctree-l2"><a class="reference internal" href="basics/macros.html">Macro Definitions</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="dsl/index.html">Domain Specific Language (DSL)</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Domain Specific Language (DSL)</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="dsl/equation.html">Expression</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsl/operator.html">Operator</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="timeIntegration/index.html">Time Integration</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Time Integration</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="timeIntegration/forwardEuler.html">Forward Euler</a></li>
<li class="toctree-l2"><a class="reference internal" href="timeIntegration/rungeKutta.html">Runge Kutta</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="finiteVolume/cellCentred/index.html">FiniteVolume</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of FiniteVolume</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="finiteVolume/cellCentred/boundaryConditions.html">Boundary Conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="finiteVolume/cellCentred/case_study.html">Case Study: The Gauss Green Div Kernel</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="datastructures/index.html">Datastructures</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Datastructures</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="datastructures/unstructuredMesh.html">UnstructuredMesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastructures/dictionary.html">Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="datastructures/database.html">Database</a></li>
</ul>
</li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">MPI Architecture</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="_sources/mpi_architecture.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="mpi-architecture">
<h1>MPI Architecture<a class="headerlink" href="#mpi-architecture" title="Link to this heading">¶</a></h1>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>Virtually all large scientific and engineering codes are too large to be practically usable with a single ‘computing unit’. Most problems are broken down into smaller parts and distributed across several ‘computing units’. In many cases these ‘computing elements’ do not share the same memory addressing space, or distributed memory architecture. This introduces the need to communicate data and synchronize the solution procedure across these ‘computing elements’. <code class="docutils literal notranslate"><span class="pre">NeoN</span></code> uses <a class="reference external" href="https://en.wikipedia.org/wiki/Message_Passing_Interface">MPI</a> to achieve this, with each ‘computing unit’ referred to as an <code class="docutils literal notranslate"><span class="pre">MPI</span> <span class="pre">rank</span></code> (<code class="docutils literal notranslate"><span class="pre">rank</span></code>). Note: for shared memory architecture (including GPU computing), see <a class="reference external" href="https://exasim-project.com/NeoN/latest/basics/executor.html">Executor</a>. Two fundamental problems need to be solved:</p>
<ol class="arabic simple">
<li><p>How should the global computation be partitioned and distributed across <code class="docutils literal notranslate"><span class="pre">ranks</span></code>?.</p></li>
<li><p>What data needs to be communicated between which <code class="docutils literal notranslate"><span class="pre">ranks</span></code>?.</p></li>
</ol>
<p>For scalable solutions, it’s crucial to ‘mask’ communication costs. Data communication should occur in parallel with the main computation to avoid holding it up and to reduce overheads. Broadly this is achieved by non-blocking communication between <code class="docutils literal notranslate"><span class="pre">ranks</span></code> in conjunction with the minimization of the frequency and size of the communication. Since the communication architecture informs the partitioning, we will discuss this first.</p>
</section>
<section id="communication">
<h2>Communication<a class="headerlink" href="#communication" title="Link to this heading">¶</a></h2>
<section id="mpi-wrapping">
<h3>MPI Wrapping<a class="headerlink" href="#mpi-wrapping" title="Link to this heading">¶</a></h3>
<p>The majority of <code class="docutils literal notranslate"><span class="pre">MPI</span></code> operators are brought into <code class="docutils literal notranslate"><span class="pre">NeoN</span></code> in the <code class="docutils literal notranslate"><span class="pre">operators.hpp</span></code> file. The purpose of this file is to wrap <code class="docutils literal notranslate"><span class="pre">MPI</span></code> functions such that they work more seamlessly with <code class="docutils literal notranslate"><span class="pre">NeoN</span></code> data types, and also to supply typical defaults. For example the <code class="docutils literal notranslate"><span class="pre">MPI_Allreduce</span></code> function is wrapped:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">valueType</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">reduceAllScalar</span><span class="p">(</span><span class="n">valueType</span><span class="o">*</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ReduceOp</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Allreduce</span><span class="p">(</span>
<span class="w">        </span><span class="n">MPI_IN_PLACE</span><span class="p">,</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">getType</span><span class="o">&lt;</span><span class="n">valueType</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">getOp</span><span class="p">(</span><span class="n">op</span><span class="p">),</span><span class="w"> </span><span class="n">comm</span>
<span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>such that scalar reduction size is handled automatically. In addition to the wrapped operators, there is the <code class="docutils literal notranslate"><span class="pre">MPI</span></code> environment which is located in the <code class="docutils literal notranslate"><span class="pre">environment.hpp</span></code> file. Contained within are two classes <code class="docutils literal notranslate"><span class="pre">MPIInit</span></code> and <code class="docutils literal notranslate"><span class="pre">MPIEnvironment</span></code>.  The former is a simple RAII class that initializes and finalizes (in the destructor) the <code class="docutils literal notranslate"><span class="pre">MPI</span></code> environment, thus a typically program using <code class="docutils literal notranslate"><span class="pre">NeoN</span></code> would start by calling the MPIInit constructor.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NeoN/core/mpi/environment.hpp&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">MPIInit</span><span class="w"> </span><span class="n">mpi</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// main solver</span>

<span class="w">    </span><span class="c1">// MPI_finalize is called in the destructor</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since we support <code class="docutils literal notranslate"><span class="pre">OpenMP</span></code> (through <code class="docutils literal notranslate"><span class="pre">Kokkos</span></code>), we need to ensure threading support is available when we start. This is checked in <code class="docutils literal notranslate"><span class="pre">MPIInit</span></code>’s constructor.</p>
</div>
<p>Once started, the <code class="docutils literal notranslate"><span class="pre">MPIEnvironment</span></code> class is used to manage the MPI communicator, <code class="docutils literal notranslate"><span class="pre">MPI_rank</span></code>, and <code class="docutils literal notranslate"><span class="pre">MPI_size</span></code>. Since the class will populate the communicator with <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code> and initialize the rank and size, the class can be constructed from anywhere in the code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the future, it is intended to use this class to manage multiple MPI communicators which are derived from the splitting of an existing communicator. By then, the above will no longer apply and the instance of <code class="docutils literal notranslate"><span class="pre">MPIEnvironment</span></code> will need to be parsed.</p>
</div>
</section>
<section id="global-communication">
<h3>Global Communication<a class="headerlink" href="#global-communication" title="Link to this heading">¶</a></h3>
<p>With the above in place, global communication (i.e. communication between all <code class="docutils literal notranslate"><span class="pre">ranks</span></code> on a <code class="docutils literal notranslate"><span class="pre">MPI_Communicator</span></code>) can be achieved by using the environment and operators.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NeoN/core/mpi/environment.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NeoN/core/mpi/operators.hpp&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">MPIInit</span><span class="w"> </span><span class="n">mpi</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">MPIEnvironment</span><span class="w"> </span><span class="n">mpiEnv</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">reduceAllScalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">ReduceOp</span><span class="o">::</span><span class="n">SUM</span><span class="p">,</span><span class="w"> </span><span class="n">mpiEnv</span><span class="p">.</span><span class="n">comm</span><span class="p">());</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">mpiEnv</span><span class="p">.</span><span class="n">rank</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Value &quot;</span><span class="o">&lt;&lt;</span><span class="n">value</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// result is number of ranks.</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="point-to-point-communication">
<h3>Point-to-Point Communication<a class="headerlink" href="#point-to-point-communication" title="Link to this heading">¶</a></h3>
<p>For simplicity, this section focuses on the approach for two ranks to communicate with each other, specifically using non-blocking communication for field data synchronization.</p>
<p>To begin, the reader is reminded of ‘communication terminology’: simplex, half-duplex, and full-duplex. Simplex communication is one-way, from sender to receiver or vice versa. Half-duplex allows two-way communication but only in one direction at a time. Full-duplex enables two-way communication simultaneously in both directions.</p>
<p>To facilitate communication between two or more ranks, a half-duplex buffer is introduced, namely the <code class="docutils literal notranslate"><span class="pre">HalfDuplexCommBuffer</span></code>, which is responsible for non-blocking sending to/receiving from different ranks and into member data buffers. To generalize the buffer for different data types, <code class="docutils literal notranslate"><span class="pre">type-punning</span></code> is used and as such the actual data which is transferred is always of type <code class="docutils literal notranslate"><span class="pre">char</span></code>. Further, since memory allocation is relatively expensive the buffer is never sized down. While the buffer memory is laid out continuously it is accessed on a per <code class="docutils literal notranslate"><span class="pre">rank</span></code> basis, which is indexed from 0 to the size for the communicated data. It is therefore required to have some map between a cell’s buffer position index and its data container (typically a <code class="docutils literal notranslate"><span class="pre">Vector</span></code> of some kind) index. The construction of this map is part of the partitioning problem, and not the responsibility of the buffer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">HalfDuplexCommBuffer</span></code> duplex buffer has some guard rails in to ensure that once communication has started, various operations are no-longer possible until it is finished.</p>
</div>
<p>To achieve full-duplex communication, two half-duplex buffers are combined to form the <code class="docutils literal notranslate"><span class="pre">FullDuplexCommBuffer</span></code>. The process for two way communication is then broken down into the following steps:</p>
<ol class="arabic simple">
<li><p>Initialize the communication, using a name and data type. This flags the buffer as a used resource.</p></li>
<li><p>Load the buffer with data to send.</p></li>
<li><p>Start the communication.</p></li>
<li><p>Do other work to mask the communication.</p></li>
<li><p>Wait for the communication to finish.</p></li>
<li><p>Unload the buffer with the received data.</p></li>
<li><p>Finalize the communication, releasing (de-flags) the buffer.</p></li>
</ol>
<p>The full communication between two ranks is thus given below:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unordered_map&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NeoN/core/mpi/environment.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NeoN/core/mpi/operators.hpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NeoN/core/mpi/comm_buffer.hpp&quot;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">MPIInit</span><span class="w"> </span><span class="n">mpi</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">MPIEnvironment</span><span class="w"> </span><span class="n">mpiEnv</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// create the buffers</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sendSize</span><span class="p">;</span><span class="w">      </span><span class="c1">// per rank communication</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">receiveSize</span><span class="p">;</span><span class="w">   </span><span class="c1">// per rank communication</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">};</span><span class="w"> </span><span class="c1">// the local data (could be a field or similar)</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sendMap</span><span class="p">;</span><span class="w"> </span><span class="c1">// assumes single rank communication</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">receiveMap</span><span class="p">;</span><span class="w"> </span><span class="c1">// assumes single rank communication</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="c1">// populate above data</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="n">NeoN</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">FullDuplexCommBuffer</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="n">mpiEnv</span><span class="p">,</span><span class="w"> </span><span class="n">sendSize</span><span class="p">,</span><span class="w"> </span><span class="n">receiveSize</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Obtain the buffer.</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">initComm</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;test_communication&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// load the send buffer</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">commRank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpiEnv</span><span class="p">.</span><span class="n">Rank</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">sendBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">getSendBuffer</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">commRank</span><span class="p">);</span><span class="w"> </span><span class="c1">// View returned.</span>
<span class="w">    </span><span class="n">sendBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allData</span><span class="p">[</span><span class="n">sendMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>

<span class="w">    </span><span class="c1">// start the non-blocking communication</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">startComm</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="c1">// do other work</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="c1">// wait for the communication to finish</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">waitComplete</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// unload the receive buffer</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">receiveBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">getReceiveBuffer</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">commRank</span><span class="p">);</span><span class="w"> </span><span class="c1">// View returned.</span>
<span class="w">    </span><span class="n">allData</span><span class="p">[</span><span class="n">receiveMap</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiveBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// finalize the communication, releasing the buffer</span>
<span class="w">    </span><span class="n">buffer</span><span class="p">.</span><span class="n">finaliseComm</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The copying to and from the buffers does introduce an overhead, which could later be removed by using ‘inplace’ communication. This remains an open point.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the future it is aimed to have dead-lock detection, to prevent program hangs when developing MPI based algorithms.</p>
</div>
</section>
<section id="vector-synchronization">
<h3>Vector Synchronization<a class="headerlink" href="#vector-synchronization" title="Link to this heading">¶</a></h3>
<p>The focus now shifts to the actual process of synchronizing a global field between all its partitioned parts. In each <code class="docutils literal notranslate"><span class="pre">rank</span></code> there is some overlap of cells (i.e. cells which are present in more than one <code class="docutils literal notranslate"><span class="pre">rank</span></code>), which is dictated by the stencil size. If these shared cell have a missing neighbor cell in a local partition they are termed <code class="docutils literal notranslate"><span class="pre">halo</span> <span class="pre">cells</span></code>. A <code class="docutils literal notranslate"><span class="pre">halo</span> <span class="pre">cell</span></code> does not have enough geometric and/or field information to be able to calculate the correct result and therefore must receive the result from another rank.</p>
<p>In the above there is no reason for the <code class="docutils literal notranslate"><span class="pre">halo</span> <span class="pre">cells</span></code> to be nicely ordered, for example to start at field index 0 and end at 10. Therefore we need some map between the <code class="docutils literal notranslate"><span class="pre">halo</span> <span class="pre">cell</span></code> index in our mesh and our data buffers in the <code class="docutils literal notranslate"><span class="pre">FullDuplexCommBuffer</span></code>, for each <code class="docutils literal notranslate"><span class="pre">rank</span></code>. This map is stored in the <code class="docutils literal notranslate"><span class="pre">RankSimplexCommMap</span></code> which stores for each <code class="docutils literal notranslate"><span class="pre">rank</span></code> which buffer position maps to which <code class="docutils literal notranslate"><span class="pre">halo</span> <span class="pre">cell</span></code> in the mesh. To facilitate full duplex communication both a send and receive <code class="docutils literal notranslate"><span class="pre">RankSimplexCommMap</span></code> is needed.</p>
<p>Arriving finally at the <code class="docutils literal notranslate"><span class="pre">Communicator</span></code>. Its role is now defined to manage the non-blocking synchronization of a field for a given communication pathway set. The user should, for each communicate point in code, provide a unique string key to identify the communication, see below is an example.</p>
<p>It is worth noting that there may be more than one field being synchronized at any give time. However, the communication pathways contained within the send and receive <code class="docutils literal notranslate"><span class="pre">RankSimplexCommMap</span></code> remains the same. Thus the <code class="docutils literal notranslate"><span class="pre">Communicator</span></code> (may) consists of a multiple of communication buffers and a single <code class="docutils literal notranslate"><span class="pre">RankSimplexCommMap</span></code>. This scaling is provided automatically.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the file line and number are used as communication key names they can allow for helpful debug messages where <code class="docutils literal notranslate"><span class="pre">MPI</span></code> communication throws an error.</p>
</div>
<p>In the above of course the logic would be situated in a solution loop, and the calls would not be made sequential as this would lead to blocking communication.</p>
</section>
</section>
<section id="partitioning">
<h2>Partitioning<a class="headerlink" href="#partitioning" title="Link to this heading">¶</a></h2>
<p>The purpose of partitioning is to divide the global computation into smaller parts that can be solved in parallel, and essentially to distribute the computation across the <code class="docutils literal notranslate"><span class="pre">ranks</span></code>.</p>
<p>Currently there is no formal partitioning system in <code class="docutils literal notranslate"><span class="pre">NeoN</span></code>, however it is assumed that all communication is done on the <code class="docutils literal notranslate"><span class="pre">MPI</span> <span class="pre">World</span></code> communicator. This is to be updated in the future, together with dynamic load balancing.</p>
</section>
<section id="future-work">
<h2>Future Work<a class="headerlink" href="#future-work" title="Link to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Allow <code class="docutils literal notranslate"><span class="pre">MPI</span> <span class="pre">Communicators</span></code> to be split, allowing for more complex partitioning of the computation.</p></li>
<li><p>GPU support.</p></li>
<li><p>Mesh partitioning</p></li>
<li><p>dead-lock detection.</p></li>
<li><p>Implement dynamic load balancing.</p></li>
<li><p>Replace, where possible, std containers with <code class="docutils literal notranslate"><span class="pre">NeoN</span></code> and/or <code class="docutils literal notranslate"><span class="pre">Kokkos</span></code> containers.</p></li>
<li><p>Performance metrics</p></li>
</ol>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          <a class="prev-page" href="datastructures/database.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Database</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, NeoN authors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">MPI Architecture</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#communication">Communication</a><ul>
<li><a class="reference internal" href="#mpi-wrapping">MPI Wrapping</a></li>
<li><a class="reference internal" href="#global-communication">Global Communication</a></li>
<li><a class="reference internal" href="#point-to-point-communication">Point-to-Point Communication</a></li>
<li><a class="reference internal" href="#vector-synchronization">Vector Synchronization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#partitioning">Partitioning</a></li>
<li><a class="reference internal" href="#future-work">Future Work</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    </body>
</html>