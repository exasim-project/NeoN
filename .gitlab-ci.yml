# SPDX-FileCopyrightText: 2023 - 2025 NeoN authors
#
# SPDX-License-Identifier: Unlicense

image: greole/neon-cuda

stages:
  - build
  - test

variables:
  GIT_STRATEGY: clone
  GIT_DEPTH: 1

build-project:
  stage: build
  tags: ["nvidia-gpus"]
  before_script:
    - pip3 install --user --break-system-packages pre-commit
    - export PATH="$HOME/.local/bin:$PATH"
    - cmake --version
    - clang++ --version || g++ --version
    - nvidia-smi
    - nvcc --version
  script:
    - cmake --preset develop -DCMAKE_CUDA_ARCHITECTURES=89 -DNeoN_WITH_THREADS=OFF
    - cmake --build --preset develop
  artifacts:
    paths:
      - build/          
    expire_in: 1h

test-project:
  stage: test
  tags: ["nvidia-gpus"]
  needs: ["build-project"]  
  script:
    - ctest --preset develop --output-on-failure
  dependencies:
    - build-project         
